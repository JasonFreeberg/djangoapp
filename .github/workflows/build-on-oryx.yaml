name: Build on container image

on:
  push:
    branches: 
      - build-on-oryx-container


jobs:
  set-env:
    runs-on: ubuntu-latest

    steps:
    - name: "Get webapp's container version"
      run: |
        # This is where we would get the site's container version and set it as an env var for the next job
        # version = (az webapp get-container-version)
        # export CONTAINER_VERSION=version

  build-and-test:
    needs: set-env
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/oryx/python-3  # https://hub.docker.com/_/microsoft-oryx-python-3-6

    steps:
    - uses: actions/checkout@v2

    - name: Create and start virtual environment # (specifically named "antenv")
      run: |
        python3 -m venv antenv
        . antenv/bin/activate

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Run tests
      run: python manage.py test

    - name: Deploy to App Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'freeberg-django-container-build'
        publish-profile: ${{ secrets.CONTAINER_BUILD_SITE_PUB_PROFILE }}
